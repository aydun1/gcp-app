<div cdkScrollable class="scroller">
  <div class="outer">
    <gcp-letterhead class="print-heading">Local deliveries</gcp-letterhead>
    <h2>Local deliveries</h2>
    <div class="options inner">
      <div class="buttons">
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="run">
          <mat-label>Run</mat-label>
          <mat-select [formControl]="runFilter" (selectionChange)="pickRun($event)">
            <mat-option value="">Default</mat-option>
            <mat-option *ngFor="let s of runs" value="{{ s.fields.Title }}">{{ s.fields.Title }}</mat-option>
            <mat-option (click)="openRunManager()"><mat-icon>add</mat-icon>Add/edit runs</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <button type="button" mat-raised-button color="primary" (click)="openCustomerPicker()" [disabled]="loading" class="action">Add delivery</button>
    </div>

    <div *ngIf="orders$ | async as orders">
      <div class="inner" *ngIf="orders.length > 0">
        <mat-accordion>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                Fulfilled orders
              </mat-panel-title>
              <mat-panel-description>
                Drag these below to add to a run!
              </mat-panel-description>
            </mat-expansion-panel-header>
            <mat-list #orderList="cdkDropList" cdkDropList [cdkDropListConnectedTo]="[deliveryList]" [cdkDropListSortingDisabled]="true">
              <mat-list-item class="drag-list-item" *ngFor="let order of orders" cdkDrag [cdkDragData]="order">
                <mat-icon matListItemIcon cdkDragHandle>drag_indicator</mat-icon>
                {{ order.sopNumber }} - {{ order.custName }}
              </mat-list-item>
            </mat-list>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
    </div>

    <mat-card appearance="outlined" class="inner">
      <mat-table #deliveryList="cdkDropList" [dataSource]="deliveries$" [trackBy]="trackByFn" cdkDropList [cdkDropListDisabled]="dragDisabled" (cdkDropListDropped)="moveItem($event)">

        <ng-container matColumnDef="sequence">
          <mat-header-cell *matHeaderCellDef> # </mat-header-cell>
          <mat-cell (touchstart)="dragDisabled = false" (mousedown)="dragDisabled = false" *matCellDef="let delivery; let index = index">
            <mat-icon class="drag">drag_indicator</mat-icon>
            {{ index + 1 }}
          </mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="customer">
          <mat-header-cell *matHeaderCellDef> Customer </mat-header-cell>
          <mat-cell *matCellDef="let delivery" [routerLink]="['/customers', delivery.fields.CustomerNumber]" [queryParams]="{site:delivery.fields.Site}">
            <a [routerLink]="['/customers', delivery.fields.CustomerNumber]" [queryParams]="{site:delivery.fields.Site}" class="customer-link">{{ delivery.fields.Customer }}</a>
          </mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="site">
          <mat-header-cell *matHeaderCellDef> Address </mat-header-cell>
          <mat-cell *matCellDef="let delivery">{{ delivery.fields.Address || delivery.fields.Site }}</mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="notes">
          <mat-header-cell *matHeaderCellDef> Notes </mat-header-cell>
          <mat-cell *matCellDef="let delivery">
            <div [innerHTML]="delivery.fields.Notes"></div>
          </mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef> Actions </mat-header-cell>
          <mat-cell *matCellDef="let delivery">
            <button mat-raised-button color="primary" (click)="openPalletDialog(delivery.fields.Customer, delivery.fields.CustomerNumber, delivery.fields.Site)">Pallets</button>
            <button mat-raised-button color="primary" (click)="openRecyclingDialog(delivery.fields.Customer, delivery.fields.CustomerNumber, delivery.fields.Site)">Recycling</button>
          </mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="status">
          <mat-header-cell *matHeaderCellDef></mat-header-cell>
          <mat-cell *matCellDef="let delivery">
            <mat-checkbox color="accent" [checked]="delivery.fields.Status === 'Complete'" (click)="markComplete(delivery.id, delivery.fields.Status)"></mat-checkbox>          </mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="menu">
          <mat-header-cell *matHeaderCellDef></mat-header-cell>
          <mat-cell *matCellDef="let delivery">
            <button mat-icon-button [matMenuTriggerData]="{delivery}" [matMenuTriggerFor]="menu" class="menu"><mat-icon>more_vert</mat-icon></button>
          </mat-cell>
          <mat-footer-cell *matFooterCellDef></mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="loading">
          <mat-footer-cell *matFooterCellDef>
            <gcp-loading-row></gcp-loading-row>
          </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="empty">
          <mat-footer-cell *matFooterCellDef>
            Click the above button to add a delivery!
          </mat-footer-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;" cdkDrag></mat-row>
        <mat-footer-row *matFooterRowDef="['loading']" [class.hidden]="(loadingList$ | async) ? false : true"></mat-footer-row>
        <mat-footer-row *matFooterRowDef="['empty']" [class.hidden]="(loadingList$ | async) === false && !listSize ? false : true"></mat-footer-row>
      </mat-table>
    </mat-card>
  </div>
</div>
<mat-menu #menu="matMenu" xPosition="before">
  <ng-template matMenuContent let-delivery="delivery">
    <button mat-menu-item (click)="editDelivery(delivery)">
      <mat-icon>edit</mat-icon>Edit
    </button>
    <button mat-menu-item (click)="deleteDelivery(delivery.id)">
      <mat-icon>delete</mat-icon>Delete
    </button>
  </ng-template>
</mat-menu>

<router-outlet></router-outlet>