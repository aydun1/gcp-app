<div class="outer">
  <h2>Requested items</h2>
  <form class="inner" [formGroup]="transferForm">
    <div class="options">
      <div class="buttons">
        <mat-form-field appearance="outline" class="branch">
          <mat-label>Branch</mat-label>
          <mat-select [formControl]="branchFilter" (selectionChange)="setBranch($event)">
            <mat-option *ngFor="let s of states" [value]="s">{{ s }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <button mat-raised-button color="primary" type="submit" [disabled]="0 && (transferQty === 0 || creating)">Save as transfer</button>
    </div>
    <div *ngIf="loading" class="loading-spinner"><mat-spinner></mat-spinner></div>

    <div *ngIf="interstateTransfers$ | async as interstateTransfers">
      <div *ngFor="let t of interstateTransfers.value['lines'] | groupByProperty:(viewFilter.value === 'grouped' ? 'poNumber' : '');trackBy: trackByGroupsFn">
        <h3 *ngIf="t.key !== 'undefined'">{{ t.key }}</h3>
        <mat-table #table [dataSource]="t.value" [trackBy]="trackByFn" formArrayName="lines">
          <ng-container matColumnDef="date">
            <mat-header-cell *matHeaderCellDef> Bin </mat-header-cell>
            <mat-cell *matCellDef="let line" [formGroupName]="line['index']">
              {{ line['bin'] }}
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>Total</mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="product">
            <mat-header-cell *matHeaderCellDef> Item </mat-header-cell>
            <mat-cell *matCellDef="let line" [formGroupName]="line['index']">
              <div class="details">
                <strong>
                  {{ line['itemNumber'] }}
                </strong>
                <div class="description">
                  {{ line['itemDesc'] }}
                </div>
                <div class="description">
                  {{ line['packSize'] || '-' }} | {{ line['palletQty'] || '-' }}
                </div>
              </div>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef></mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <mat-header-cell *matHeaderCellDef>
              <div class="loadDetails right">
                Qty required
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let line" [formGroupName]="line['index']">
              <div class="loadDetails right">
                {{ line['qtyRequired'] | number }}
              </div>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="available">
            <mat-header-cell *matHeaderCellDef>
              <div class="loadDetails right">
                VIC qty
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let line" [formGroupName]="line['index']">
              <div class="loadDetails right">
                {{ line['vicOnHand'] | number }}
              </div>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="toFill">
            <mat-header-cell *matHeaderCellDef>
              <div class="loadDetails right">
                Qty to fill
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let line" [formGroupName]="line['index']">
              <div class="loadDetails right">
                {{ line['toFill'] | number }}
              </div>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="transfer">
            <mat-header-cell *matHeaderCellDef>
              <div class="loadDetails">
                Send 
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let line" [formGroupName]="line['index']">
              <input formControlName="toTransfer" class="transfer-input" type="number" placeholder="0" min="0">
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
              <div class="transferTotal">
                {{ getTotalToTransfer(t.value) | number }}
              </div>
            </mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="loading">
            <mat-footer-cell *matFooterCellDef>
              <gcp-loading-row></gcp-loading-row>
            </mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="empty">
            <mat-footer-cell *matFooterCellDef>
              There are no items requested from {{ branchFilter.value }}.
            </mat-footer-cell>
          </ng-container>

          <ng-container matColumnDef="unpicked">
            <mat-footer-cell *matFooterCellDef>
              Pick a branch to see their requested items!
            </mat-footer-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
          <mat-footer-row *matFooterRowDef="['loading']" [class.hidden]="!loading"></mat-footer-row>
          <mat-footer-row *matFooterRowDef="['empty']" [class.hidden]="loading || getTotalRequestedLines(t.value)"></mat-footer-row>
          <mat-footer-row *matFooterRowDef="displayedColumns"></mat-footer-row>
        </mat-table>
      </div>
    </div>
  </form>
</div>


<router-outlet></router-outlet>